å¥½çš„ï¼Œè¿™æ˜¯ä¸€ä»½ä¸ºä½ å‡†å¤‡çš„ã€å¯ä»¥ç›´æ¥ç”¨äºåç»­å¼€å‘å’ŒAIåä½œçš„**é¡¹ç›®æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (æœ€ç»ˆç‰ˆ)**ã€‚

è¿™ä»½æ–‡æ¡£æ•´åˆäº†ä½ é¡¹ç›®çš„æ‰€æœ‰éœ€æ±‚ï¼ŒåŒ…æ‹¬æ¶æ„ã€å¹³å°ã€æ’ä»¶ç³»ç»Ÿã€ä»¥åŠä½ æä¾›çš„è¯¦ç»†æˆ˜æ–—æœºåˆ¶ï¼ˆå¦‚æœ¯è¯­æ›¿æ¢ã€è¡ŒåŠ¨æ¡ã€å›åˆã€ä¼¤å®³å…¬å¼ç­‰ï¼‰ã€‚

-----

### ğŸ—‚ï¸ æ–‡æ¡£ï¼šé¡¹ç›®æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ (æœ€ç»ˆç‰ˆ)

**é¡¹ç›®ä»£å·ï¼š** TSAuto

**é¡¹ç›®ç›®æ ‡ï¼š** å¼€å‘ä¸€ä¸ª**ä»¥å¤æ‚2Då›åˆåˆ¶æˆ˜æ–—ä¸ºæ ¸å¿ƒ**ï¼ˆæœºåˆ¶æ·±åº¦å¯¹æ ‡ã€Šé˜´é˜³å¸ˆã€‹ï¼‰çš„åˆ·å­æ¸¸æˆã€‚æ¸¸æˆå°†è·¨å¹³å°ï¼ˆWindows, macOS, Linux, iOS, Androidï¼‰è¿è¡Œã€‚

**æ ¸å¿ƒéœ€æ±‚ï¼š**

1.  **å…¨å¹³å°è¦†ç›–ï¼š** ä¸€å¥—ä»£ç åº“ï¼Œè¿è¡Œåœ¨æ‰€æœ‰ä¸»æµæ¡Œé¢å’Œç§»åŠ¨å¹³å°ã€‚
2.  **åŒè¿è¡Œæ¨¡å¼ï¼š** æœ¬åœ°æ¨¡å¼ (IndexedDB) å’Œè”ç½‘æ¨¡å¼ (PostgreSQL + WebSocket)ã€‚
3.  **é«˜å¼€å‘æ•ˆç‡ï¼š** æ‰€æœ‰ç•Œé¢ï¼ˆåŒ…æ‹¬æˆ˜æ–—ï¼‰éƒ½ä½¿ç”¨React (DOM) é«˜æ•ˆå¼€å‘ã€‚
4.  **å¤æ‚æ’ä»¶ç³»ç»Ÿï¼š** è§’è‰²ã€æŠ€èƒ½ã€è£…å¤‡ç­‰ä½œä¸ºæ’ä»¶åŠ¨æ€åŠ è½½ã€‚
5.  **é«˜å¤æ‚åº¦æˆ˜æ–—å¼•æ“ï¼š**
      * å®ç°æ–‡æ¡£ä¸­å®šä¹‰çš„**å¤æ‚è¡ŒåŠ¨æ¡æœºåˆ¶**ï¼ˆåŸºäºå…¨åœºä¸€é€Ÿï¼‰ã€‚
      * åŒºåˆ†**çœŸå›åˆ**ï¼ˆæ¨è¿›èµ„æºæ¡ï¼‰å’Œ**ä¼ªå›åˆ**ï¼ˆä¸æ¨è¿›ï¼‰ã€‚
      * ç²¾ç¡®å¤ç°æ–‡æ¡£ä¸­å®šä¹‰çš„**ä¼¤å®³è®¡ç®—å…¬å¼**ã€‚
      * å®ç°åŸºäº**æˆé•¿å€¼ x æˆé•¿ç‚¹**çš„å±æ€§ç³»ç»Ÿã€‚
6.  **æœ¯è¯­å¯é…ç½®ï¼š** æ‰€æœ‰æ¸¸æˆå†…çš„ä¸“æœ‰åè¯ï¼ˆå¦‚"é¬¼ç«"ã€"å¾¡é­‚"ï¼‰å¿…é¡»é€šè¿‡ä¸€ä¸ªå…¨å±€é…ç½®æ–‡ä»¶è¿›è¡Œæ›¿æ¢ï¼Œä»¥è§„é¿ç‰ˆæƒé£é™©ã€‚
7.  **ç®€åŒ–çš„æˆ˜æ–—è¡¨ç°ï¼š** æˆ˜æ–—è¡¨ç°å°†**å®Œå…¨ä½¿ç”¨DOMï¼ˆHTML/CSS/Reactï¼‰** æ¥å®ç°ï¼ˆä¾‹å¦‚å¤´åƒåŠ¨ç”»ã€ç«‹ç»˜å±•ç¤ºã€ä¼¤å®³æ•°å­—ï¼‰ã€‚

-----

### 1\. ğŸ›ï¸ æ ¸å¿ƒæ¶æ„ç†å¿µï¼šç»Ÿä¸€UIæ¸²æŸ“

æ•´ä¸ªæ¸¸æˆï¼ˆåŒ…æ‹¬æ‰€æœ‰èœå•å’Œæˆ˜æ–—åœºæ™¯ï¼‰éƒ½å°†æ˜¯ä¸€ä¸ª**ç»Ÿä¸€çš„Reactåº”ç”¨**ã€‚æˆ˜æ–—åœºæ™¯æœ¬èº«å°†æ˜¯ä¸€ä¸ªReactç»„ä»¶ (`<BattleScene />`)ï¼Œå®ƒä½¿ç”¨æ ‡å‡†çš„DOMå…ƒç´ ï¼ˆ`div`, `img`ï¼‰å’ŒCSSåŠ¨ç”»æ¥æ„å»ºã€‚

  * **èœå•/ç¼–é˜Ÿ/èƒŒåŒ…ï¼š** ä½¿ç”¨Reactç»„ä»¶æ„å»ºã€‚
  * **æˆ˜æ–—åœºæ™¯ï¼š** **åŒæ ·ä½¿ç”¨Reactç»„ä»¶æ„å»º**ã€‚
      * å¼ç¥ç«‹ç»˜/å¤´åƒï¼šä½¿ç”¨ `<img>` æ ‡ç­¾ã€‚
      * å¤´åƒåŠ¨ç”»ï¼šä½¿ç”¨ GIFã€APNGã€WebP æˆ– CSS `transform` / `animation`ã€‚
      * ä¼¤å®³æ•°å­—/Buffå›¾æ ‡ï¼šä½¿ç”¨Reactç»„ä»¶ï¼Œé€šè¿‡CSSè¿‡æ¸¡å’ŒåŠ¨ç”»æ¥å®ç°å¼¹å‡ºã€æ¶ˆå¤±ç­‰æ•ˆæœã€‚

-----

### 2\. ğŸ› ï¸ è¯¦ç»†æŠ€æœ¯æ ˆ

#### å®¢æˆ·ç«¯ (The Game)

  * **è¯­è¨€ï¼š** **TypeScript**
  * **UIæ¡†æ¶ (DOM)ï¼š** **React**
  * **çŠ¶æ€ç®¡ç†ï¼š** **Zustand** (ç”¨äºå…¨å±€çŠ¶æ€å’Œæˆ˜æ–—çŠ¶æ€)
  * **æ„å»ºå·¥å…·ï¼š** **Vite**

#### è·¨å¹³å°å°è£…å±‚ (The Shell)

  * **æ¡Œé¢ (Win/Mac/Linux)ï¼š** **Tauri**
  * **ç§»åŠ¨ (iOS/Android)ï¼š** **Capacitor**

#### æœåŠ¡ç«¯ (Online Mode)

  * **åç«¯æ¡†æ¶ï¼š** **NestJS (Node.js)**
  * **ä¸»æ•°æ®åº“ï¼š** **PostgreSQL**
  * **ç¼“å­˜/æ’è¡Œæ¦œ/åŒ¹é…ï¼š** **Redis**
  * **è®¤è¯ï¼š** **JWT**
  * **å®æ—¶é€šä¿¡ï¼š** **WebSockets (é€šè¿‡ NestJS Gateway)**

#### æ•°æ®ä¸å­˜å‚¨ (Data)

  * **æœ¬åœ°å­˜å‚¨ï¼š** **`localForage`** (å°è£… IndexedDB)
  * **æ’ä»¶æ ¼å¼ï¼š** **TypeScript å¯¹è±¡**

-----

### 3\. ğŸ§© æ ¸å¿ƒæ’ä»¶ä¸æˆ˜æ–—ç³»ç»Ÿ

è¿™æ˜¯æœ¬TDDçš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†ä¸¥æ ¼æŒ‰ç…§ä½ æä¾›çš„æœºåˆ¶æ–‡æ¡£æ¥å®ç°æˆ˜æ–—å¼•æ“ã€‚

#### 3.1 æ­¥éª¤ 0ï¼šæœ¯è¯­é…ç½®

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªä¸­å¿ƒåŒ–çš„æœ¯è¯­é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰UIå’Œæ’ä»¶æè¿°éƒ½å°†å¼•ç”¨å®ƒã€‚

**`src/core/config/terms.ts`**

```typescript
// è¯¥æ–‡ä»¶å®šä¹‰äº†æ‰€æœ‰å¯è¢«æ›¿æ¢çš„æœ¯è¯­
export const TERMS = {
  // åŸºç¡€
  GAME_TITLE: "æˆ‘çš„æ¸¸æˆ",
  COPYRIGHT_INFO: "MyCompany Â© 2025",

  // è§’è‰²ç›¸å…³
  CHARACTER: "å¼ç¥",
  LEVEL: "ç­‰çº§",
  AWAKEN: "è§‰é†’",

  // æˆ˜æ–—èµ„æº
  BATTLE_RESOURCE: "é¬¼ç«",
  ACTION_BAR: "è¡ŒåŠ¨æ¡",

  // è£…å¤‡/é“å…·
  EQUIPMENT: "å¾¡é­‚",
  EQUIPMENT_SET_EFFECT: "å¥—è£…æ•ˆæœ",

  // å±æ€§
  STAT_HP: "ç”Ÿå‘½",
  STAT_ATK: "æ”»å‡»",
  STAT_DEF: "é˜²å¾¡",
  STAT_SPD: "é€Ÿåº¦",
  STAT_CRIT: "æš´å‡»",
  STAT_CRIT_DMG: "æš´å‡»ä¼¤å®³",
};
```

**ä½¿ç”¨ç¤ºä¾‹ (React ç»„ä»¶)ï¼š**

```tsx
import { TERMS } from '../core/config/terms';
const SkillBar = () => {
  return <div>æ¶ˆè€— {TERMS.BATTLE_RESOURCE}: 3</div>;
}
```

#### 3.2 æ­¥éª¤ 1ï¼šå®šä¹‰"å¥‘çº¦" (Interfaces)

æ’ä»¶æ¥å£å¿…é¡»ç²¾ç¡®åæ˜ ä½ çš„æœºåˆ¶æ–‡æ¡£ã€‚

**`src/core/types/definitions.ts`**

```typescript
// æˆ˜æ–—äº‹ä»¶ç±»å‹
export type BattleEventType = 
  | "ON_BATTLE_START" 
  | "ON_TURN_START" 
  | "ON_TURN_END" 
  | "ON_DAMAGE_DEALT" 
  | "ON_HEAL_RECEIVED" 
  | "ON_STATUS_APPLIED" 
  | "ON_CHARACTER_DEATH"
  | ...; // å…¶ä»–æœªæ¥æ‰©å±•çš„äº‹ä»¶

// å›åˆç±»å‹
export type TurnType = "NORMAL" | "NEW_TURN" | "PSEUDO_TURN";

/**
 * å¯æ‰§è¡Œæ•ˆæœ
 */
export interface Effect {
  type:
    | "DAMAGE"
    | "HEAL"
    | "APPLY_STATUS"
    | "MODIFY_ACTION_BAR" // "æ‹‰æ¡"æˆ–"æ¨æ¡"
    | "GAIN_EXTRA_TURN"   // è·å¾— "æ–°å›åˆ"
    | "TRIGGER_PSEUDO_TURN" // è§¦å‘ "ä¼ªå›åˆ"
    | ...;

  target: "SELF" | "TARGET" | "ALL_ALLIES" | "ALL_ENEMIES" | "RANDOM_ENEMY";

  // 'MODIFY_ACTION_BAR'
  // 0.3 = æ‹‰æ¡30%, -0.5 = æ¨æ¡50%
  amount?: number;

  // 'GAIN_EXTRA_TURN' & 'TRIGGER_PSEUDO_TURN'
  // ä¼ªå›åˆå¯èƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªæŠ€èƒ½æ¥æ‰§è¡Œ
  pseudoTurnSkillId?: string;

  // 'DAMAGE'
  // ä¼¤å®³å…¬å¼æ˜¯å…¨å±€çš„ï¼Œè¿™é‡Œåªå®šä¹‰ç³»æ•°
  damageMultiplier: number; // (ä¾‹å¦‚ 1.2 = 120% æ”»å‡»çš„ä¼¤å®³)

  // ... å…¶ä»–æ•ˆæœçš„ç‰¹å®šå±æ€§
}

/**
 * è§’è‰² (å¼ç¥) å®šä¹‰
 */
export interface CharacterDefinition {
  id: string;
  name: string;
  assets: {
    avatar: string;
    portrait: string;
  };

  // æˆ‘ä»¬ä¸å­˜ baseStatsï¼Œæˆ‘ä»¬å­˜ "æˆé•¿å€¼"
  // è§‰é†’å‰/åçš„æˆé•¿å€¼æ˜¯ä¸åŒçš„
  growthValues: {
    hp: number; // ä¾‹å¦‚ 300.5
    atk: number; // ä¾‹å¦‚ 180.2
    def: number; // ä¾‹å¦‚ 100.0
    spd: number; // ä¾‹å¦‚ 110 (é€Ÿåº¦é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œä¸å‚ä¸æˆé•¿ç‚¹)
    crit: number; // ä¾‹å¦‚ 0.1
    critDmg: number; // ä¾‹å¦‚ 1.5
  };

  skills: [string, string, string]; // æŠ€èƒ½IDæ•°ç»„
}

/**
 * è£…å¤‡ (å¾¡é­‚) å®šä¹‰
 */
export interface EquipmentDefinition {
  id: string;
  name: string;
  setId: string; // å¥—è£…ID, e.g., "PO_SHI"
  slot: 1 | 2 | 3 | 4 | 5 | 6; // 6ä¸ªä½ç½®

  // è£…å¤‡æ’ä»¶åªå®šä¹‰ "æ˜¯ä»€ä¹ˆ"
  // "æ€ä¹ˆæˆé•¿" ç”±æ¸¸æˆé€»è¾‘ (EquipmentService) å®šä¹‰
}

/**
 * æŠ€èƒ½å®šä¹‰
 */
export interface SkillDefinition {
  id: string;
  name: string;
  description: string;
  cost: { type: "BATTLE_RESOURCE", amount: number }; // (ä½¿ç”¨æœ¯è¯­)

  activeEffects?: Effect[];
  passiveListeners?: {
    event: BattleEventType;
    effects: Effect[];
  }[];
}
```

#### 3.3 æ­¥éª¤ 2ï¼šæ ¸å¿ƒé€»è¾‘ - å±æ€§ä¸è£…å¤‡

æˆ‘ä»¬åˆ›å»ºæœåŠ¡æ¥å¤„ç†ä½ æ–‡æ¡£ä¸­çš„å…¬å¼ã€‚

**`src/core/services/CharacterStatsService.ts`**

```typescript
// è¯¥æ–‡ä»¶å­˜å‚¨äº†ç­‰çº§å¯¹åº”çš„ "æˆé•¿ç‚¹"
const GROWTH_POINTS_TABLE = {
  1: 10,
  2: 12,
  // ...
  40: 100, // (ç¤ºä¾‹)
};

export class CharacterStatsService {
  /**
   * è·å–ç­‰çº§å¯¹åº”çš„ "æˆé•¿ç‚¹"
   */
  static getGrowthPoints(level: number): number {
    return GROWTH_POINTS_TABLE[level] || 0;
  }

  /**
   * è®¡ç®—æœ€ç»ˆé¢æ¿å±æ€§
   */
  static calculatePanelStat(growthValue: number, level: number, isHp: boolean = false): number {
    const growthPoints = this.getGrowthPoints(level);
    const stat = growthValue * growthPoints;
    return isHp ? stat + 1 : stat; // HP = æˆé•¿å€¼ Ã— æˆé•¿ç‚¹ + 1
  }
}
```

**`src/core/services/EquipmentService.ts`**

```typescript
// è¯¥æ–‡ä»¶å®ç°äº†å¾¡é­‚å‰¯å±æ€§çš„æˆé•¿é€»è¾‘

const STAT_GROWTH_TYPE_1_RANGE = [2.4, 3.0]; // é€Ÿåº¦, æš´å‡»ç­‰
const STAT_GROWTH_TYPE_2_RANGE = [3.2, 4.0]; // çˆ†ä¼¤, å‘½ä¸­ç­‰

export class EquipmentService {
  /**
   * ä¸ºä¸€ä»¶è£…å¤‡ç”Ÿæˆä¸€ä¸ªæ–°çš„å‰¯å±æ€§ï¼ˆæˆ–å¼ºåŒ–ï¼‰
   * è¿™å°†ä½¿ç”¨ Irwin-Hall(n) åˆ†å¸ƒï¼ˆæˆ–ç®€åŒ–çš„å‡åŒ€åˆ†å¸ƒï¼‰
   */
  static rollSecondaryStat(statType: string): number {
    if (["SPD", "CRIT", "ATK_P", "DEF_P", "HP_P"].includes(statType)) {
      // è¿”å› 2.4 åˆ° 3.0 ä¹‹é—´çš„ä¸€ä¸ªéšæœºå€¼
      return Math.random() * (3.0 - 2.4) + 2.4;
    } else {
      // è¿”å› 3.2 åˆ° 4.0 ä¹‹é—´çš„ä¸€ä¸ªéšæœºå€¼
      return Math.random() * (4.0 - 3.2) + 3.2;
    }
  }

  // ... å…¶ä»–å¼ºåŒ–ã€å‡çº§ã€ç”Ÿæˆè£…å¤‡çš„é€»è¾‘
}
```

#### 3.4 æ­¥éª¤ 3ï¼šæ ¸å¿ƒé€»è¾‘ - æˆ˜æ–—å¼•æ“

`BattleEngine` å°†è¢«é‡æ„ï¼Œä»¥åŒ…å«ä½ å¤æ‚çš„ `TurnManager` å’Œ `DamageCalculator`ã€‚

**`src/core/battle/TurnManager.ts`**

```typescript
import type { CharacterInstance } from './BattleEngine';

export class TurnManager {
  private characters: CharacterInstance[];
  private globalFastestSpeed: number;

  constructor(allCharacters: CharacterInstance[]) {
    this.characters = allCharacters;

    // 1. è®¡ç®— "å…¨åœºä¸€é€Ÿ"
    this.globalFastestSpeed = Math.max(...allCharacters.map(c => c.getStat("SPD")));

    // 2. åˆå§‹åŒ– "åˆå§‹ä½ç½®"
    for (const char of this.characters) {
      char.actionBarPosition = char.getStat("SPD");
    }
  }

  /**
   * "æ‹‰æ¡" æˆ– "æ¨æ¡"
   */
  pushPullBar(target: CharacterInstance, percentage: number) {
    // æ¨æ‹‰æ¡é•¿åº¦ = å…¨åœºä¸€é€Ÿ Ã— æ¨æ‹‰æ¡æ¯”ä¾‹
    const pullAmount = this.globalFastestSpeed * percentage;

    // æ¨æ‹‰æ¡åä½ç½®
    target.actionBarPosition += pullAmount;

    // è‹¥æ¨æ‹‰æ¡åä½ç½® < 0ï¼Œåˆ™ä¸º 0
    if (target.actionBarPosition < 0) {
      target.actionBarPosition = 0;
    }
  }

  /**
   * è·å–ä¸‹ä¸€ä¸ªè¡ŒåŠ¨å•ä½
   */
  getNextTurn(): CharacterInstance {
    let nextChar: CharacterInstance | null = null;
    let minTimeToEndpoint = Infinity;

    for (const char of this.characters) {
      if (char.isDead) continue;

      // è·ç¦»ç»ˆç‚¹é•¿åº¦
      const distance = this.globalFastestSpeed - char.actionBarPosition;
      if (distance <= 0) {
        // å·²åœ¨ç»ˆç‚¹ï¼Œä¼˜å…ˆçº§æœ€é«˜ (å¤„ç†å¤šä¸ªåœ¨ç»ˆç‚¹çš„æƒ…å†µ)
        // TODO: å®ç°è¡ŒåŠ¨é¡ºåºé€»è¾‘ (è§„åˆ™ 2, 3, 4)
        return char; 
      }

      // åˆ°è¾¾ç»ˆç‚¹æ—¶é—´ = è·ç¦» / (é€Ÿåº¦ + Buffé€Ÿåº¦)
      const currentSpd = char.getStat("SPD") + char.getBuffs("SPD");
      const time = distance / currentSpd;

      if (time < minTimeToEndpoint) {
        minTimeToEndpoint = time;
        nextChar = char;
      }
    }

    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå•ä½åï¼Œå°†å…¶è¡ŒåŠ¨æ¡ä½ç½®è®¾ä¸º 0 (æˆ–ä»ç»ˆç‚¹å›é€€)
    nextChar.actionBarPosition = 0; // (ç®€åŒ–å¤„ç†ï¼Œå®é™…å¯èƒ½æ›´å¤æ‚)
    return nextChar!;
  }
}
```

**`src/core/battle/DamageCalculator.ts`**

```typescript
export class DamageCalculator {
  /**
   * ä¼¤å®³è®¡ç®—æ€»å…¬å¼
   */
  static calculateDamage(caster: CharacterInstance, target: CharacterInstance, skillMultiplier: number): number {
    
    const baseAtk = caster.getStat("ATK"); // åŸºç¡€æ”»å‡» (å·²é€šè¿‡ æˆé•¿å€¼*æˆé•¿ç‚¹ è®¡ç®—)
    const atkBonus = caster.getBuffs("ATK_P"); // æ”»å‡»å¢å‡
    const equipAtk = caster.getEquipmentStats("ATK_FLAT"); // å¾¡é­‚æ”»å‡» (å›ºå®šå€¼)

    const critDmg = caster.getStat("CRIT_DMG"); // æš´å‡»ä¼¤å®³

    const dmgBonus = caster.getBuffs("DMG_BONUS"); // ä¼¤å®³å¢å‡
    const dmgTakenBonus = target.getBuffs("DMG_TAKEN_BONUS"); // æ‰¿å—ä¼¤å®³å¢å‡

    const ignoreDefP = caster.getBuffs("IGNORE_DEF_P"); // æ— è§†é˜²å¾¡
    const targetDef = target.getStat("DEF"); // æ•Œæ–¹é˜²å¾¡
    const ignoreDefFlat = caster.getBuffs("IGNORE_DEF_FLAT"); // å¿½ç•¥é˜²å¾¡
    const targetDefBonus = target.getBuffs("DEF_P"); // é˜²å¾¡å¢å‡

    // æ€»ä¼¤å®³ = (åŸºç¡€æ”»å‡» Ã— (1 + æ”»å‡»å¢å‡) + å¾¡é­‚æ”»å‡»)
    const atkPart = (baseAtk * (1 + atkBonus) + equipAtk);

    // Ã— æš´å‡»ä¼¤å®³ (æ­¤å¤„ç®€åŒ–ï¼Œæœªå¤„ç†æš´å‡»åˆ¤å®š)
    const critPart = critDmg;

    // Ã— (1 + ä¼¤å®³å¢å‡ + æ‰¿å—ä¼¤å®³å¢å‡)
    const bonusPart = (1 + dmgBonus + dmgTakenBonus);

    // Ã— (300 / (300 + (1 - æ— è§†é˜²å¾¡) Ã— (æ•Œæ–¹é˜²å¾¡ - å¿½ç•¥é˜²å¾¡) Ã— (1 + é˜²å¾¡å¢å‡)))
    const defCalc = (targetDef - ignoreDefFlat) * (1 + targetDefBonus);
    const defPart = (300 / (300 + (1 - ignoreDefP) * defCalc));

    // åˆ«å¿˜äº†æŠ€èƒ½æœ¬èº«çš„ç³»æ•°
    const skillPart = skillMultiplier;

    // TODO: å®Œå–„æš´å‡»åˆ¤å®š
    const totalDamage = atkPart * critPart * bonusPart * defPart * skillPart;

    return totalDamage;
  }
}
```

**`src/core/battle/BattleEngine.ts`**

```typescript
import { GameData } from '../GameData';
import { TurnManager } from './TurnManager';
import { DamageCalculator } from './DamageCalculator';
import type { SkillDefinition, Effect, TurnType } from '../types/definitions';
// (ä½ éœ€è¦å®šä¹‰ CharacterInstance, BattleState, EventBus)

class BattleEngine {
  public state: BattleState;
  private eventBus: EventBus;
  private onStateChange: (newState: BattleState) => void;
  private turnManager: TurnManager;

  constructor(team1: CharacterDefinition[], team2: CharacterDefinition[], onStateChangeCallback: (s: BattleState) => void) {
    // ... åˆå§‹åŒ–è§’è‰²å®ä¾‹ (allCharacters)
    this.onStateChange = onStateChangeCallback;
    this.state = this.createInitialState(team1, team2);
    this.turnManager = new TurnManager(allCharacters);
    this.setupPassives();
    this.onStateChange(this.state); // æ¨é€åˆå§‹çŠ¶æ€
  }

  // æˆ˜æ–—ä¸»å¾ªç¯
  async startTurn(turnType: TurnType = "NORMAL") {
    // 1. æ¨è¿›é¬¼ç«æ¡
    if (turnType === "NORMAL") {
      this.state.resourceManager.advance(); // (æ¨è¿›é¬¼ç«æ¡)
    }
    // "NEW_TURN" å’Œ "PSEUDO_TURN" ä¸æ¨è¿›

    const activeChar = this.turnManager.getNextTurn();
    this.state.activeCharacterId = activeChar.instanceId;
    this.eventBus.emit("ON_TURN_START", { target: activeChar });

    // 2. ç­‰å¾…ç©å®¶è¾“å…¥æˆ–AI
    const { skill, target } = await getPlayerInput(activeChar); // (éœ€è¦å®ç°)

    // 3. æ‰§è¡ŒæŠ€èƒ½
    this.executeSkill(activeChar, target, skill, turnType);
  }

  executeSkill(caster, target, skillDef: SkillDefinition, turnType: TurnType) {
    // ... (æ£€æŸ¥èµ„æº cost)
    for (const effect of skillDef.activeEffects) {
      this.applyEffect(caster, target, effect);
    }

    // 4. å›åˆç»“æŸ
    if (turnType !== "PSEUDO_TURN") {
      this.eventBus.emit("ON_TURN_END", { target: caster });
    }
    // (ä¼ªå›åˆä¸è§¦å‘å›åˆç»“æŸ)
  }

  applyEffect(caster, target, effect: Effect) {
    switch (effect.type) {
      case "DAMAGE":
        const damage = DamageCalculator.calculateDamage(caster, target, effect.damageMultiplier);
        target.takeDamage(damage);
        this.eventBus.emit("ON_DAMAGE_DEALT", { caster, target, damage });
        break;
      case "MODIFY_ACTION_BAR":
        this.turnManager.pushPullBar(target, effect.amount);
        break;
      case "GAIN_EXTRA_TURN":
        // ç»™äºˆç›®æ ‡ä¸€ä¸ª "NEW_TURN"
        // é€»è¾‘ï¼šå°†å…¶è¡ŒåŠ¨æ¡æ‹‰åˆ°æœ€æ»¡ï¼Œå¹¶æ ‡è®°ä¸ºæ–°å›åˆ
        this.turnManager.pushPullBar(target, 1.0); // (ç®€åŒ–å®ç°)
        target.nextTurnType = "NEW_TURN";
        break;
      case "TRIGGER_PSEUDO_TURN":
        // ç«‹å³æ‰§è¡Œä¸€ä¸ªä¼ªå›åˆ
        // (è¿™éœ€è¦ä¸€ä¸ªæ›´å¤æ‚çš„å †æ ˆå¼æ‰§è¡Œï¼Œæˆ–è®©ç›®æ ‡ç«‹å³è¡ŒåŠ¨)
        const pseudoSkill = GameData.getSkill(effect.pseudoTurnSkillId);
        this.executeSkill(caster, target, pseudoSkill, "PSEUDO_TURN");
        break;
      // ...
    }
  }

  setupPassives() {
    // ...
    // (éå†æ‰€æœ‰è§’è‰²çš„æŠ€èƒ½å’ŒçŠ¶æ€ï¼Œè®¢é˜…äº‹ä»¶æ€»çº¿)
    // ...
  }
}
```

#### 3.5 æ­¥éª¤ 4ï¼šè¿æ¥å¼•æ“ä¸React

è¿™éƒ¨åˆ†è´Ÿè´£å°†çº¯TSçš„ `BattleEngine` å’Œ React UI è¿æ¥èµ·æ¥ã€‚

**`src/hooks/useBattleStore.ts` (Zustand Store)**

```typescript
import create from 'zustand';
import { BattleEngine } from '../core/BattleEngine';
import type { BattleState } from '../core/types/battle'; // (ä½ éœ€è¦å®šä¹‰è¿™äº›ç±»å‹)
import type { CharacterDefinition } from '../core/types/definitions';

interface BattleStore {
  battleState: BattleState | null;
  engine: BattleEngine | null;
  startBattle: (team1: CharacterDefinition[], team2: CharacterDefinition[]) => void;
  playerAction: (skillId: string, targetId: string) => void;
}

const useBattleStore = create<BattleStore>((set, get) => ({
  battleState: null,
  engine: null,
  startBattle: (team1, team2) => {
    const engine = new BattleEngine(team1, team2, (newState) => {
      // å¼•æ“çš„å›è°ƒå‡½æ•°ï¼šæ›´æ–°Zustandçš„çŠ¶æ€
      set({ battleState: newState });
    });
    set({ engine, battleState: engine.state });
  },
  // UI è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥æ‰§è¡Œç©å®¶æ“ä½œ
  playerAction: (skillId, targetId) => {
    // æ³¨æ„ï¼šå¼•æ“çš„ playerAction éœ€è¦æ˜¯å¼‚æ­¥çš„
    get().engine?.playerAction(skillId, targetId);
  }
}));

export default useBattleStore;
```

**`src/components/BattleScene.tsx` (Reactæˆ˜æ–—åœºæ™¯)**

```typescript
import React, { useEffect, useState } from 'react';
import useBattleStore from '../hooks/useBattleStore';
import { CharacterAvatar } from './CharacterAvatar'; // (ä½ éœ€è¦åˆ›å»ºè¿™ä¸ªç»„ä»¶)
import { SkillBar } from './SkillBar'; // (ä½ éœ€è¦åˆ›å»ºè¿™ä¸ªç»„ä»¶)

export function BattleScene({ playerTeam, enemyTeam }) {
  const { battleState, startBattle, playerAction } = useBattleStore();
  const [selectedSkill, setSelectedSkill] = useState<string | null>(null);

  // æˆ˜æ–—åˆå§‹åŒ–
  useEffect(() => {
    startBattle(playerTeam, enemyTeam);
  }, [startBattle, playerTeam, enemyTeam]);

  if (!battleState) {
    return <div>Loading Battle...</div>;
  }

  const handleTargetClick = (targetInstanceId: string) => {
    if (selectedSkill) {
      playerAction(selectedSkill, targetInstanceId);
      setSelectedSkill(null); // é‡ç½®æŠ€èƒ½é€‰æ‹©
    }
  };

  return (
    <div className="battle-scene">
      {/* æ¸²æŸ“æ•Œäºº */}
      <div className="enemy-team">
        {battleState.enemies.map(char => (
          <CharacterAvatar
            key={char.instanceId}
            character={char}
            onClick={() => handleTargetClick(char.instanceId)}
          />
        ))}
      </div>
      
      {/* æ¸²æŸ“æˆ‘æ–¹ */}
      <div className="player-team">
        {battleState.players.map(char => (
          <CharacterAvatar 
            key={char.instanceId} 
            character={char} 
            onClick={() => handleTargetClick(char.instanceId)} 
          />
        ))}
      </div>
      
      {/* æ¸²æŸ“æŠ€èƒ½æ UI */}
      <SkillBar 
        activeCharacter={battleState.activeCharacter} 
        onSkillClick={(skillId) => setSelectedSkill(skillId)} 
      />

      {/* (ä½ è¿˜éœ€è¦ä¸€ä¸ªç»„ä»¶æ¥æ¸²æŸ“ä¼¤å®³æ•°å­—ã€Buffå›¾æ ‡ç­‰) */}
    </div>
  );
}
```

#### 3.6 æ­¥éª¤ 5ï¼šåŠ¨æ€åŠ è½½æ’ä»¶ (Plugin Loader)

æˆ‘ä»¬ä½¿ç”¨ Vite çš„ `import.meta.glob` åŠŸèƒ½æ¥è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ’ä»¶æ¨¡å—ã€‚

**`src/core/GameData.ts`**

```typescript
import type { CharacterDefinition, SkillDefinition, StatusDefinition, EquipmentDefinition } from './types/definitions';

// 1. åŒ¹é…æ‰€æœ‰æ’ä»¶ç›®å½•ä¸‹çš„ .ts æ–‡ä»¶
// 'eager: true' ä¼šåŒæ­¥å¯¼å…¥æ‰€æœ‰æ¨¡å—
const characterModules = import.meta.glob('../plugins/characters/*.ts', { eager: true });
const skillModules = import.meta.glob('../plugins/skills/*.ts', { eager: true });
const statusModules = import.meta.glob('../plugins/statuses/*.ts', { eager: true });
const equipmentModules = import.meta.glob('../plugins/equipment/*.ts', { eager: true });

// å®šä¹‰æ•°æ®åº“
const ALL_CHARACTERS: Record<string, CharacterDefinition> = {};
const ALL_SKILLS: Record<string, SkillDefinition> = {};
const ALL_STATUSES: Record<string, StatusDefinition> = {};
const ALL_EQUIPMENT: Record<string, EquipmentDefinition> = {};

// è¾…åŠ©å‡½æ•°ï¼šåŠ è½½æ¨¡å—
function loadPlugins(modules: Record<string, any>, targetDb: Record<string, any>) {
  for (const path in modules) {
    const module = modules[path];
    for (const key in module) {
      const plugin = module[key];
      // ç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªåˆæ³•çš„æ’ä»¶ (æœ‰ id)
      if (plugin && plugin.id) {
        targetDb[plugin.id] = plugin;
      }
    }
  }
}

// å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰
loadPlugins(characterModules, ALL_CHARACTERS);
loadPlugins(skillModules, ALL_SKILLS);
loadPlugins(statusModules, ALL_STATUSES);
loadPlugins(equipmentModules, ALL_EQUIPMENT);

// 3. å¯¼å‡ºä¸€ä¸ªæ˜“äºè®¿é—®çš„æ¸¸æˆæ•°æ®åº“
export class GameData {
  static getCharacter(id: string): CharacterDefinition {
    return ALL_CHARACTERS[id];
  }

  static getSkill(id: string): SkillDefinition {
    return ALL_SKILLS[id];
  }

  static getStatus(id: string): StatusDefinition {
    return ALL_STATUSES[id];
  }

  static getEquipment(id: string): EquipmentDefinition {
    return ALL_EQUIPMENT[id];
  }

  static getAllCharacters(): CharacterDefinition[] {
    return Object.values(ALL_CHARACTERS);
  }

  static getAllSkills(): SkillDefinition[] {
    return Object.values(ALL_SKILLS);
  }

  static getAllStatuses(): StatusDefinition[] {
    return Object.values(ALL_STATUSES);
  }

  static getAllEquipment(): EquipmentDefinition[] {
    return Object.values(ALL_EQUIPMENT);
  }
}
```

-----
### 4\. ğŸ¯ AI åŠ©æ‰‹çš„ä½¿ç”¨æŒ‡å—

**ä½œä¸ºæˆ‘çš„AIå¼€å‘åŠ©æ‰‹ï¼Œè¯·ä½ åŸºäºæ­¤æ–‡æ¡£ï¼š**

1.  **æœ¯è¯­ä¼˜å…ˆï¼š** å½“æˆ‘è¦æ±‚åˆ›å»ºUIç»„ä»¶ï¼ˆä¾‹å¦‚â€œæŠ€èƒ½æ â€ï¼‰æˆ–æ’ä»¶ï¼ˆâ€œæŠ€èƒ½æè¿°â€ï¼‰æ—¶ï¼Œ**å¿…é¡»**ä½¿ç”¨ `src/core/config/terms.ts` (ä¾‹å¦‚ `TERMS.BATTLE_RESOURCE`)ï¼Œ**ç¦æ­¢**ç¡¬ç¼–ç â€œé¬¼ç«â€ã€â€œå¾¡é­‚â€ç­‰è¯æ±‡ã€‚
2.  **å®ç°è¡ŒåŠ¨æ¡ï¼š** å½“æˆ‘è¦æ±‚â€œå®ç°å›åˆç®¡ç†â€æˆ–â€œæ‹‰æ¡â€æ—¶ï¼Œä½ **å¿…é¡»**å¼•ç”¨ `TurnManager.ts` ä¸­çš„é€»è¾‘ï¼Œå¹¶ä½¿ç”¨**å…¨åœºä¸€é€Ÿ** (`globalFastestSpeed`) ä½œä¸ºè®¡ç®—åŸºå‡†ã€‚
3.  **å®ç°ä¼¤å®³ï¼š** å½“æˆ‘è¦æ±‚â€œè®¡ç®—ä¼¤å®³â€æ—¶ï¼Œä½ **å¿…é¡»**ä½¿ç”¨ `DamageCalculator.ts` ä¸­å®šä¹‰çš„**å®Œæ•´ä¼¤å®³å…¬å¼**ã€‚
4.  **å®ç°å±æ€§ï¼š** å½“æˆ‘è¦æ±‚â€œè®¡ç®—è§’è‰²é¢æ¿â€æ—¶ï¼Œä½ **å¿…é¡»**ä½¿ç”¨ `CharacterStatsService.ts` ä¸­çš„ **`calculatePanelStat` (æˆé•¿å€¼ Ã— æˆ kennt + 1)** å…¬å¼ã€‚
5.  **å®ç°å›åˆï¼š** å½“æˆ‘è¦æ±‚â€œåˆ›å»ºæ–°æŠ€èƒ½â€æ—¶ï¼Œå¦‚æœå®ƒæä¾›é¢å¤–å›åˆï¼Œä½ **å¿…é¡»**æ˜ç¡®åŒºåˆ† `GAIN_EXTRA_TURN` (æ–°å›åˆï¼Œä¸æ¨é¬¼ç«æ¡) å’Œ `TRIGGER_PSEUDO_TURN` (ä¼ªå›åˆï¼Œä¸æ¨é¬¼ç«æ¡ï¼Œä¸è§¦å‘å›åˆç»“æŸ)ã€‚
6.  **å®ç°å¾¡é­‚ï¼š** å½“æˆ‘è¦æ±‚â€œå¼ºåŒ–è£…å¤‡â€æ—¶ï¼Œä½ **å¿…é¡»**å¼•ç”¨ `EquipmentService.ts` ä¸­å®šä¹‰çš„**å‰¯å±æ€§æˆé•¿åŒºé—´**ï¼ˆä¾‹å¦‚ 2.4% \~ 3.0%ï¼‰ã€‚
7.  **æ¶æ„ä¸å˜ï¼š** å§‹ç»ˆè®°ä½æ¸²æŸ“å±‚æ˜¯ **100% React (DOM)**ï¼Œä¸è¦æä¾› Canvas æˆ– PixiJS ä»£ç ã€‚

### 5\. ğŸŒ ç½‘ç»œæ¶æ„è®¾è®¡

#### 5.1 åŒæ¨¡å¼æ¶æ„

æ¸¸æˆéœ€è¦æ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š

1. **æœ¬åœ°æ¨¡å¼ (Local Mode)**
   - ä½¿ç”¨ IndexedDB (é€šè¿‡ localForage å°è£…)
   - æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°
   - æ— éœ€ç½‘ç»œè¿æ¥

2. **åœ¨çº¿æ¨¡å¼ (Online Mode)**
   - ä½¿ç”¨ PostgreSQL + Redis
   - æ”¯æŒå¤šäººæ¸¸æˆã€æ’è¡Œæ¦œã€äº‘å­˜æ¡£
   - éœ€è¦ç½‘ç»œè¿æ¥

#### 5.2 æ•°æ®åŒæ­¥ç­–ç•¥

**æœ¬åœ°æ¨¡å¼ â†’ åœ¨çº¿æ¨¡å¼è¿ç§»ï¼š**

```typescript
class DataMigrationService {
  static async migrateLocalToOnline(localData: LocalGameData, userId: string): Promise<void> {
    // 1. éªŒè¯æœ¬åœ°æ•°æ®å®Œæ•´æ€§
    if (!this.validateLocalData(localData)) {
      throw new Error('Invalid local data format');
    }

    // 2. è½¬æ¢æ•°æ®æ ¼å¼
    const onlineData = this.convertToOnlineFormat(localData);

    // 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
    await api.uploadGameData(userId, onlineData);

    // 4. æ¸…ç†æœ¬åœ°æ•°æ®ï¼ˆå¯é€‰ï¼‰
    // await localForage.clear();
  }

  static async migrateOnlineToLocal(userId: string): Promise<LocalGameData> {
    const onlineData = await api.downloadGameData(userId);
    return this.convertToLocalFormat(onlineData);
  }
}
```

#### 5.3 å®æ—¶é€šä¿¡

**WebSocket äº‹ä»¶å®šä¹‰ï¼š**

```typescript
// å®¢æˆ·ç«¯å‘é€çš„äº‹ä»¶
type ClientToServerEvents = {
  'JOIN_BATTLE': (battleId: string) => void;
  'PLAYER_ACTION': (action: PlayerAction) => void;
  'LEAVE_BATTLE': () => void;
};

// æœåŠ¡å™¨å‘é€çš„äº‹ä»¶
type ServerToClientEvents = {
  'BATTLE_START': (state: BattleState) => void;
  'STATE_UPDATE': (state: BattleState) => void;
  'PLAYER_JOINED': (playerId: string) => void;
  'PLAYER_LEFT': (playerId: string) => void;
  'BATTLE_END': (result: BattleResult) => void;
};
```

### 6\. ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 6.1 æˆ˜æ–—æ€§èƒ½ä¼˜åŒ–

1. **çŠ¶æ€æ›´æ–°ä¼˜åŒ–**
   - ä½¿ç”¨ä¸å¯å˜æ•°æ®ç»“æ„
   - æ‰¹é‡æ›´æ–°UIçŠ¶æ€
   - é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

2. **åŠ¨ç”»ä¼˜åŒ–**
   - ä½¿ç”¨ CSS transform è€Œé position
   - å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
   - åˆç†æ§åˆ¶åŠ¨ç”»å¸§ç‡

3. **å†…å­˜ç®¡ç†**
   - åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
   - é‡Šæ”¾ä¸ç”¨çš„èµ„æº
   - é™åˆ¶å¹¶å‘åŠ¨ç”»æ•°é‡

#### 6.2 èµ„æºåŠ è½½ä¼˜åŒ–

1. **ä»£ç åˆ†å‰²**
   - è·¯ç”±çº§åˆ«çš„æ‡’åŠ è½½
   - æˆ˜æ–—ç³»ç»Ÿçš„æŒ‰éœ€åŠ è½½
   - æ’ä»¶çš„åŠ¨æ€å¯¼å…¥

2. **èµ„æºç¼“å­˜**
   - å›¾ç‰‡é¢„åŠ è½½
   - éŸ³é¢‘èµ„æºç®¡ç†
   - CDNåŠ é€Ÿ

-----

### 7\. ğŸ“± ç§»åŠ¨ç«¯é€‚é…

#### 7.1 å“åº”å¼è®¾è®¡

```scss
// æ–­ç‚¹å®šä¹‰
$breakpoints: (
  'mobile': 320px,
  'tablet': 768px,
  'desktop': 1024px,
  'wide': 1440px
);

// æˆ˜æ–—åœºæ™¯å“åº”å¼å¸ƒå±€
.battle-scene {
  display: flex;
  flex-direction: column;
  
  @media (min-width: map-get($breakpoints, 'tablet')) {
    flex-direction: row;
  }
  
  .player-team,
  .enemy-team {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }
}
```

#### 7.2 è§¦æ§ä¼˜åŒ–

- æ‰©å¤§å¯ç‚¹å‡»åŒºåŸŸ (44px æœ€å°å°ºå¯¸)
- æ·»åŠ è§¦æ§åé¦ˆ
- ä¼˜åŒ–æ»‘åŠ¨æ‰‹åŠ¿
- æ”¯æŒå¤šæŒ‡è§¦æ§

#### 7.3 æ€§èƒ½è°ƒä¼˜

- é™ä½æ¸²æŸ“å¤æ‚åº¦
- ä¼˜åŒ–è§¦æ‘¸äº‹ä»¶å¤„ç†
- æ§åˆ¶ç²’å­æ•ˆæœæ•°é‡
- æ™ºèƒ½é™çº§æœºåˆ¶

-----

### 8\. **æä¾›APIï¼š** å½“æˆ‘è¦æ±‚"å®ç°PvP"æ—¶ï¼Œä¸ºæˆ‘æä¾› **NestJS WebSocket Gateway** çš„ä»£ç æ¥å¤„ç†å®æ—¶æˆ˜æ–—çŠ¶æ€åŒæ­¥ï¼Œä»¥åŠ `BattleEngine` å¦‚ä½•è¢«ä¿®æ”¹ä¸ºé€šè¿‡WebSocketï¼ˆè€Œä¸æ˜¯æœ¬åœ°å›è°ƒï¼‰æ¥åŒæ­¥ `battleState`ã€‚