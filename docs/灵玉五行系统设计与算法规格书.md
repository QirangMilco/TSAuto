# TSAuto 灵玉五行系统设计与算法规格书 (v1.0)

**版本**：1.0
**核心模块**：灵玉装备系统 (Spirit Jade System)
**关键词**：五行固定槽位、流转压力模型、快照式算法、无死循环

-----

## 1\. 系统概述 (System Overview)

本系统旨在构建一个基于\*\*“五行相生相克”**的深度策略装备体系。
与传统RPG不同，本系统采用**“槽位属性固定”**机制，强调**“全局平衡”\*\*而非单点堆砌。玩家必须像调节生态系统一样调节五个槽位的强度，避免因五行失衡导致的连锁削弱。

### 1.1 槽位定义

灵玉盘采用正五边形布局，顺时针排列，属性固定不可变：

  * **1号位 [金]** (Metal) - 主宰攻伐
  * **2号位 [水]** (Water) - 主宰润泽
  * **3号位 [木]** (Wood) - 主宰生长
  * **4号位 [火]** (Fire) - 主宰爆发
  * **5号位 [土]** (Earth) - 主宰承载

-----

## 2\. 玩法逻辑：压力与流转 (Gameplay Mechanics)

### 2.1 核心状态定义

每个槽位在计算时会处于以下三种状态之一：

1.  **健康 (Healthy)**：未受克制，且上游供给充足。发挥 100% 效能，并向下游提供满额加成。
2.  **被压制 (Suppressed)**：**克星太强**且**疏导者太弱**。自身属性打折（如只剩 50%），且向下游提供的加成大幅减少。
3.  **枯竭 (Starved)**：自身未被克制，但**上游处于“被压制”状态**，导致供给断裂。自身属性不变，但**无法向下游提供加成**。

### 2.2 逻辑链条示例

**场景**：玩家极度强化了 **[土]**，但 **[金]**（土生金，金生水）和 **[水]** 练度较低。

1.  **克制发生**：**[土]** (强) 克制 **[水]** (弱)。
2.  **疏导失败**：中间的 **[金]** 练度不足，无法化解土对水的压力。
3.  **结果 A (水被压制)**：**[水]** 槽位显示红色警告，主属性效能降低至 **30%**。
4.  **连锁结果 B (木枯竭)**：**[水]** 生 **[木]**。因水灵力微弱，传输给木的加成极低，**[木]** 进入“枯竭”状态。
5.  **最终恶果 C (火断供)**：**[木]** 生 **[火]**。因木处于枯竭态，无法激活火的共鸣加成。**[火]** 槽位没有任何额外增益。

-----

## 3\. 算法实现规范 (Technical Implementation)

为了避免五行循环依赖导致的死循环（A变导致B变，B变又导致A变），采用\*\*“三步流水线” (3-Pass Pipeline)\*\* 算法。计算是**静态、一次性**的。

### 3.1 数据结构

```typescript
interface JadeSlot {
    index: number;       // 0:金, 1:水, 2:木, 3:火, 4:土
    rawPower: number;    // 原始战力评分 (基于装备白值)
    
    // 计算过程变量 (临时)
    efficiency: number;  // 效率系数 (默认为1.0，被克制会降低)
    
    // 最终输出结果
    finalStats: Stat[];  // 最终生效的属性
    status: 'HEALTHY' | 'SUPPRESSED' | 'STARVED'; // UI显示状态
}
```

### 3.2 算法流程 (The Pipeline)

此函数在玩家穿戴/更换装备的瞬间执行一次。

#### 步骤一：读取原始数据 (Pass 1: Raw Data)

系统遍历 5 个槽位，仅读取装备的基础属性，计算出 `rawPower`。

  * *此时不考虑任何五行关系。*

#### 步骤二：克制判定 (Pass 2: Inhibition Calculation)

计算每个槽位的 `efficiency`。此步骤只看\*\*“爷孙”\*\*关系。

  * **逻辑**：
      * `Enemy` = 上上个节点 (克我者)
      * `Bridge` = 上一个节点 (生我者/疏导者)
      * **判定公式**：如果 `Enemy.rawPower > Bridge.rawPower * 阈值系数(如1.5)`，则判定疏导失败。
      * **惩罚**：`Me.efficiency` 降低（例如降为 0.5）。

#### 步骤三：相生流转 (Pass 3: Generation & Starvation)

计算传递给下游的增益。此步骤依赖步骤二的结果。

  * **逻辑**：
      * `Parent` = 上一个节点 (生我者)
      * **输入流 (Inflow)** = `Parent.rawPower` \* `Parent.efficiency` \* `转化率(0.2)`
  * **枯竭判定**：
      * 如果 `Inflow` 低于特定阈值（温饱线），则标记当前节点为 `STARVED`。
      * **关键惩罚**：处于 `STARVED` 状态的节点，其向它的下游提供的加成强制归零（或大幅衰减）。
  * **结算**：将 `Inflow` 叠加到当前节点的最终属性中。

### 3.3 核心算法伪代码 (TypeScript)

```typescript
const INHIBIT_THRESHOLD = 1.5; // 克制阈值：克星是桥梁的1.5倍强时触发
const STARVATION_LINE = 100;   // 枯竭阈值：接收到的灵力低于100时触发
const FLOW_RATE = 0.2;         // 转化率：20%属性传给下游

function calculateFiveElements(slots: JadeSlot[]): JadeSlot[] {
    
    // --- Pass 2: 计算克制与效率 (Efficiency) ---
    for (let i = 0; i < 5; i++) {
        let me = slots[i];
        let enemy = slots[(i + 3) % 5];  // 克星 (如水之于土)
        let bridge = slots[(i + 4) % 5]; // 桥梁 (如水之于金)

        // 判定：桥梁是否太弱，无法支撑克星的压力
        if (enemy.rawPower > bridge.rawPower * INHIBIT_THRESHOLD) {
            me.efficiency = 0.5; // 被压制，只剩5成效能
            me.status = 'SUPPRESSED';
        } else {
            me.efficiency = 1.0;
            me.status = 'HEALTHY'; // 暂定健康
        }
    }

    // --- Pass 3: 计算相生与枯竭 (Flow & Starvation) ---
    for (let i = 0; i < 5; i++) {
        let me = slots[i];
        let parent = slots[(i + 4) % 5]; // 父母节点

        // 核心连锁逻辑：父母给我的，是它“打折后”的能力
        let inflow = parent.rawPower * parent.efficiency * FLOW_RATE;

        if (inflow < STARVATION_LINE) {
            // 判定枯竭：虽然我没被克，但我吃不饱
            if (me.status === 'HEALTHY') {
                me.status = 'STARVED'; 
            }
            // 惩罚：我虽然属性不变，但我“断供”了，我的下游将拿不到加成
            // (注：这需要在UI上体现，并不需要改写这一轮的数值，
            //  因为下游的计算只依赖我的 rawPower 和 efficiency，
            //  我们可以在这里记录一个 flag，让UI显示连接线断裂)
        }
        
        // 写入最终加成
        me.finalBonus = inflow;
    }

    return slots;
}
```

-----

## 4\. UI/UX 表现需求 (UI Specification)

算法的结果必须直观地反馈给玩家，以便进行策略调整。

### 4.1 连线视觉状态

五边形的外圈连线（相生线）和内圈连线（克制线）应有不同状态：

| 状态 | 视觉表现 | 含义 |
| :--- | :--- | :--- |
| **流光 (Green)** | 绿色/金色流动光效 | **相生激活**。上游供给充足，节点健康。 |
| **断裂 (Grey)** | 灰色虚线/暗淡 | **枯竭断供**。上游处于压制或枯竭态，无加成。 |
| **射线 (Red)** | 红色带刺/脉冲射线 | **严重压制**。克星节点向当前节点发射的射线，表示属性被削减。 |

### 4.2 槽位状态反馈

  * **被压制 (Suppressed)**：槽位图标闪烁红光，并在旁边显示 `效率 50%` 的红色字样。
  * **枯竭 (Starved)**：槽位图标变得晦暗（灰度增加），显示 `营养不良` 或 `枯萎` 图标。

### 4.3 强化预警系统

当玩家在强化界面准备升级某个灵玉时（例如升级土），如果这次升级会导致某个数值突破阈值从而压制下游（水），界面必须弹出提示：

> ⚠️ **警告：土灵力过盛！**
> 继续强化将导致 [水] 位灵玉效率下降至 50%。
> *建议同步提升 [金] 位灵玉以化解压力。*