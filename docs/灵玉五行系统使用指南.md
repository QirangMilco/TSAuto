# 灵玉五行系统使用指南

## 1. 系统概述

灵玉五行系统是TSAuto项目的一个可扩展模块，为装备系统添加了五行相生相克机制。该系统设计为高度可配置和可扩展，支持动态调整槽位数量、开启/关闭五行机制以及自定义五行关系。

## 2. 核心概念

### 2.1 五行元素

系统默认支持五种元素：
- 金 (METAL)
- 水 (WATER)
- 木 (WOOD)
- 火 (FIRE)
- 土 (EARTH)

### 2.2 元素关系

- **相生**：金生水，水生木，木生火，火生土，土生金
- **相克**：金克木，木克土，土克水，水克火，火克金

### 2.3 元素状态

- **健康 (HEALTHY)**：100% 效率，完全发挥作用
- **被抑制 (SUPPRESSED)**：50% 效率，效果减半
- **饥饿 (STARVED)**：自身属性正常，但无法为其他元素提供加成

## 3. 配置系统

五行系统的所有行为都可以通过配置文件进行调整，位于 `src/core/config/fiveElements.ts`。

### 3.1 核心开关

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    // 核心开关 - 可以完全关闭五行系统
    ENABLED: true,
    // 其他配置...
};
```

### 3.2 槽位配置

通过 `SLOT_ELEMENT_MAPPINGS` 可以配置槽位与元素的对应关系，支持动态调整槽位数量：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    // 槽位与元素的映射关系
    SLOT_ELEMENT_MAPPINGS: [
        { slot: 1, element: ElementType.METAL, name: '金', description: '攻击型槽位' },
        { slot: 2, element: ElementType.WATER, name: '水', description: '支持型槽位' },
        { slot: 3, element: ElementType.WOOD, name: '木', description: '生长型槽位' },
        { slot: 4, element: ElementType.FIRE, name: '火', description: '爆发型槽位' },
        { slot: 5, element: ElementType.EARTH, name: '土', description: '防御型槽位' },
        // 可以轻松添加更多槽位映射
        // { slot: 6, element: ElementType.METAL, name: '金', description: '额外金槽位' },
        // { slot: 7, element: ElementType.WATER, name: '水', description: '额外水槽位' },
    ],
    // 其他配置...
};
```

### 3.3 五行关系配置

通过 `ELEMENT_RELATIONS` 可以配置元素间的相生相克关系：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    // 五行关系定义
    ELEMENT_RELATIONS: [
        // 相生关系
        { source: ElementType.METAL, target: ElementType.WATER, type: ElementRelationType.GENERATES, multiplier: 0.2 },
        // 相克关系
        { source: ElementType.METAL, target: ElementType.WOOD, type: ElementRelationType.RESTRAINS, multiplier: 1.5 },
        // 可以添加更多自定义关系
    ],
    // 其他配置...
};
```

### 3.4 计算参数配置

通过 `CALCULATION_PARAMS` 可以调整五行计算的各项参数：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    // 计算参数
    CALCULATION_PARAMS: {
        // 抑制阈值 - 如果相克元素的强度超过此倍数，会被抑制
        SUPPRESSION_THRESHOLD: 1.5,
        
        // 饥饿阈值 - 如果元素强度低于此值，会进入饥饿状态
        STARVATION_THRESHOLD: 100,
        
        // 效率系数
        EFFICIENCY: {
            [ElementType.METAL]: 1.0,
            [ElementType.WATER]: 1.0,
            [ElementType.WOOD]: 1.0,
            [ElementType.FIRE]: 1.0,
            [ElementType.EARTH]: 1.0,
        },
        
        // 状态效率修正
        STATE_EFFICIENCY_MODIFIERS: {
            healthy: 1.0,    // 健康 - 100% 效率
            suppressed: 0.5, // 被抑制 - 50% 效率
            starved: 1.0,    // 饥饿 - 自身效率正常，但无法提供加成
        },
    },
    // 其他配置...
};
```

## 4. 扩展装备槽数量

### 4.1 修改装备系统配置

在 `src/core/config/equipments.ts` 中修改槽位数量：

```typescript
export const EQUIPMENT_CONFIG = {
    // 装备槽数量配置
    SLOT_COUNT: 7, // 修改为需要的槽位数量
    // 其他配置...
};
```

### 4.2 添加槽位主属性配置

在同一文件中，为新槽位添加主属性配置：

```typescript
export const EQUIPMENT_CONFIG = {
    // 主属性分布规则
    SLOT_MAIN_STATS: {
        1: [StatType.ATK],
        // 其他现有配置...
        7: [StatType.ATK_P, StatType.HP_P, StatType.DEF_P, StatType.CRIT, StatType.CRIT_DMG], // 新槽位的主属性
    },
    // 其他配置...
};
```

### 4.3 添加五行槽位映射

在 `src/core/config/fiveElements.ts` 中为新槽位添加五行映射：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    SLOT_ELEMENT_MAPPINGS: [
        // 现有映射...
        { slot: 6, element: ElementType.METAL, name: '金', description: '额外金槽位' },
        { slot: 7, element: ElementType.WATER, name: '水', description: '额外水槽位' },
    ],
    // 其他配置...
};
```

## 5. 自定义装备套装

### 5.1 添加新套装

在 `src/core/config/equipmentSets.ts` 中添加新的套装配置，支持任意件数的套装加成：

```typescript
export const EQUIPMENT_SETS = {
    // 示例：6件套套装
    'SIX_SET': {
        id: 'SIX_SET',
        name: '六件套示例',
        effects: {
            2: { stat: StatType.ATK_P, value: 10 },
            4: { stat: StatType.CRIT, value: 15 },
            6: { stat: StatType.CRIT_DMG, value: 30, description: "六件套效果：暴击伤害大幅提升" }
        }
    },
    
    // 示例：7件套套装
    'SEVEN_SET': {
        id: 'SEVEN_SET',
        name: '七件套示例',
        effects: {
            2: { stat: StatType.HP_P, value: 10 },
            4: { stat: StatType.DEF_P, value: 15 },
            6: { stat: StatType.SPD, value: 20 },
            7: { description: "七件套效果：获得终极增益", effectId: "EFF_ULTIMATE" }
        }
    }
};
```

## 6. 开启/关闭五行系统

### 6.1 全局开关

在 `src/core/config/fiveElements.ts` 中修改 `ENABLED` 配置：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    // 关闭五行系统
    ENABLED: false,
    // 其他配置...
};
```

### 6.2 运行时控制

也可以在运行时动态修改五行系统的开关状态：

```typescript
import { FIVE_ELEMENTS_CONFIG } from '../config/fiveElements';

// 开启五行系统
FIVE_ELEMENTS_CONFIG.ENABLED = true;

// 关闭五行系统
FIVE_ELEMENTS_CONFIG.ENABLED = false;
```

## 7. 扩展五行元素

### 7.1 添加新元素类型

在 `src/core/types/fiveElements.ts` 中添加新元素：

```typescript
export enum ElementType {
    METAL = 'metal',      // 金
    WATER = 'water',      // 水
    WOOD = 'wood',        // 木
    FIRE = 'fire',        // 火
    EARTH = 'earth',      // 土
    LIGHT = 'light',      // 新增：光
    DARK = 'dark',        // 新增：暗
}
```

### 7.2 配置新元素关系

在 `src/core/config/fiveElements.ts` 中为新元素添加关系配置：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    ELEMENT_RELATIONS: [
        // 现有关系...
        // 新增光元素关系
        { source: ElementType.LIGHT, target: ElementType.DARK, type: ElementRelationType.RESTRAINS, multiplier: 1.5 },
        { source: ElementType.LIGHT, target: ElementType.METAL, type: ElementRelationType.GENERATES, multiplier: 0.2 },
        // 新增暗元素关系
        { source: ElementType.DARK, target: ElementType.LIGHT, type: ElementRelationType.RESTRAINS, multiplier: 1.5 },
        { source: ElementType.DARK, target: ElementType.EARTH, type: ElementRelationType.GENERATES, multiplier: 0.2 },
    ],
    // 其他配置...
};
```

## 8. 使用示例

### 8.1 获取五行计算结果

```typescript
import { FiveElementsService } from '../services/FiveElementsService';
import { EquipmentService } from '../services/EquipmentService';

// 创建装备实例
const equipment = EquipmentService.createEquipment(equipmentDef);

// 计算五行结果
const fiveElementsResult = FiveElementsService.calculateFiveElements([equipment]);

// 获取各槽位的五行信息
const slotElements = fiveElementsResult.slotElements;

// 获取总元素强度
const totalPower = fiveElementsResult.totalPower;

// 获取元素状态统计
const stateSummary = fiveElementsResult.stateSummary;
```

### 8.2 计算包含五行加成的总属性

```typescript
import { EquipmentService } from '../services/EquipmentService';

// 创建装备实例数组
const equipments = [/* 装备实例 */];

// 计算包含五行加成的总属性
const totalStats = EquipmentService.calculateTotalStats(equipments);
```

## 9. 性能优化

### 9.1 关闭五行系统

如果不需要五行系统，可以完全关闭以提高性能：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    ENABLED: false,
    // 其他配置...
};
```

### 9.2 简化五行关系

减少五行关系数量可以提高计算性能：

```typescript
export const FIVE_ELEMENTS_CONFIG = {
    ELEMENT_RELATIONS: [
        // 只保留核心关系
        { source: ElementType.METAL, target: ElementType.WATER, type: ElementRelationType.GENERATES, multiplier: 0.2 },
        { source: ElementType.WATER, target: ElementType.WOOD, type: ElementRelationType.GENERATES, multiplier: 0.2 },
        // 可以删除部分相克关系
    ],
    // 其他配置...
};
```

## 10. 测试与验证

### 10.1 运行测试用例

项目包含完整的测试用例，用于验证五行系统的功能和扩展性：

```bash
npm run test tests/unit/services/FiveElementsService.test.ts
```

### 10.2 测试覆盖范围

- 五行系统开关功能
- 5、6、7个装备槽位支持
- 2、4、6、7件套装备支持
- 相生关系计算
- 相克关系计算

## 11. 最佳实践

1. **从小规模开始**：先使用默认配置，然后逐步调整
2. **测试效果**：每次修改配置后，运行测试用例验证
3. **考虑性能**：根据实际需求调整五行关系复杂度
4. **文档化配置**：为自定义配置添加注释，便于后续维护
5. **向后兼容**：修改配置时，确保不破坏现有功能

## 12. 常见问题

### 12.1 五行系统不生效

- 检查 `ENABLED` 配置是否为 `true`
- 检查装备槽位是否有对应的五行映射
- 检查装备是否正确创建和配置

### 12.2 新增槽位没有五行效果

- 检查是否为新槽位添加了五行映射
- 检查是否为新槽位添加了主属性配置
- 检查装备系统的槽位数量配置是否正确

### 12.3 性能问题

- 考虑关闭五行系统或简化五行关系
- 确保只在必要时调用五行计算函数
- 考虑缓存计算结果，避免重复计算

## 13. 结论

灵玉五行系统设计为高度可扩展和可配置，支持动态调整槽位数量、开启/关闭五行机制以及自定义五行关系。通过合理配置，可以为游戏添加丰富的五行玩法，同时保持良好的性能和灵活性。